<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Streamzy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="preload" href="https://cdn.jsdelivr.net/gh/ChocoCooper/Streamzy@main/Sevarothz.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/ChocoCooper/Streamzy/refs/heads/main/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/ChocoCooper/Streamzy/refs/heads/main/apple-touch-icon.png">
    <link rel="manifest" href="https://raw.githubusercontent.com/ChocoCooper/Streamzy/refs/heads/main/manifest.json">
    <style>
        @font-face {
           font-family: 'Sevarothz';
           src: url('https://cdn.jsdelivr.net/gh/ChocoCooper/Streamzy@main/Sevarothz.woff2') format('woff2');
           font-weight: normal;
           font-style: normal;
           font-display: block;
           size-adjust: 150%;
        }

        :root {
            --primary-color: #2af598;
            --secondary-color: #000000;
            --text-color: #ffffff;
            --card-bg: #1f1f1f;
            --selector-bg: #333333;
            --selector-active: #2af598;
            --selector-text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-family: 'Lexend', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAACJJREFUKFNjZICC/////6f/nyH8//8/AwgYGBgYGBj8P/8/AJ0BCwU8y8MAAAAASUVORK5CYII=');
        }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--secondary-color);
            display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 1; transition: opacity 0.3s ease;
        }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid var(--primary-color); border-top: 5px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        .search-loading { text-align: center; padding: 10px; color: var(--primary-color); }
        .retry-button { background: var(--primary-color); color: #000; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: 700; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .container { max-width: 100%; padding: 0; margin: 0; }
        .header { display: flex; align-items: center; padding: 10px 5px; background: rgba(0, 0, 0, 0.9); position: relative; z-index: 20; width: 100%; }
        .header-content { display: flex; align-items: center; flex: 1; overflow: hidden; }
        h1 { font-family: 'Sevarothz', sans-serif; color: var(--primary-color); font-weight: normal; font-size: 1.75rem; margin-top: 14px; margin-left: 18px; }
        .search-icon { margin-left: auto; color: var(--primary-color); font-size: 1.5rem; cursor: pointer; margin-right: 15px; transition: transform 0.3s ease; }
        .back-arrow { color: var(--primary-color); font-size: 1.25rem; cursor: pointer; margin-left: 15px; margin-right: 20px; margin-top: 0px; transition: transform 0.3s ease; order: 0; }
        .back-arrow:hover { transform: scale(1.1); }
        .media-title { font-family: 'Lexend', sans-serif; color: var(--text-color); font-size: 1rem; margin: 0; margin-left: 5px; margin-top: -2px; white-space: pre-wrap; overflow: hidden; text-overflow: ellipsis; max-width: calc(100% - 60px); }

        .search-container { width: 100%; background: rgba(0, 0, 0, 0.95); padding: 2px 20px; display: none; z-index: 19; position: relative; }
        .search-container.active { display: block; }
        .search-box { width: 100%; max-width: 400px; padding: 4px 12px; font-size: 1rem; border: 1px solid var(--primary-color); border-radius: 5px; background: #222; color: var(--text-color); outline: none; margin: 0 auto; display: block; }
        .search-results { margin-top: 10px; max-height: 300px; overflow-y: auto; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; }
        .search-result-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.3s ease; }
        .search-result-item:hover { background: #2a2a2a; }
        .search-result-poster { width: 50px; height: 75px; object-fit: cover; margin-right: 10px; border-radius: 3px; }
        .search-result-info { flex: 1; }
        .search-result-title { font-size: 0.9rem; color: var(--text-color); }
        .search-result-year { font-size: 0.8rem; color: #aaa; }

        .preview-section { position: relative; width: 100vw; padding-bottom: 56.25%; height: auto; overflow: hidden; margin-bottom: 30px; left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw; background: #000; box-shadow: inset 0 -100px 60px -20px rgba(0, 0, 0, 0.9); }
        .preview-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 1s ease; z-index: 1; opacity: 0; }
        .preview-background.active { opacity: 1; }
        .preview-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.3) 50%, transparent 100%); z-index: 2; }
        .preview-content { position: absolute; bottom: 30px; left: 0; width: 100%; padding: 0 15px; z-index: 3; max-width: none; }
        .preview-title img { max-height: 60px; max-width: 50%; width: auto; opacity: 0; animation: fadeIn 0.8s ease forwards; }
        .preview-genres { font-size: 0.7rem; color: rgba(255, 255, 255, 0.8); margin: 5px 0; opacity: 0; animation: fadeIn 1s forwards 0.7s; }
        .preview-buttons { display: flex; gap: 10px; z-index: 3; }
        .preview-btn { padding: 6px 12px; margin-bottom: -30px; border-radius: 8px; background-color: var(--primary-color); color: black; border: none; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }

        .video-page { display: none; width: 100%; background: #000; min-height: 100vh; }
        .video-page.active { display: block; }
        .video-header { display: flex; align-items: center; padding: 10px 5px; background: rgba(0, 0, 0, 0.9); position: relative; z-index: 20; width: 100%; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; }
        iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; background: #000; }

        .selector-container { position: relative; width: 100%; background: transparent; padding: 5px; display: none; }
        .selector-container.active { display: block; }
        .selector-title { color: var(--primary-color); font-size: 1rem; margin-left: 10px; margin-bottom: 8px; font-weight: 700; }
        .server-buttons, .season-buttons, .episode-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
        .server-buttons { justify-content: center; margin-top: 8px; margin-bottom: 25px; }
        .season-buttons { margin-left: 11px; margin-bottom: 25px; max-height: 66px; overflow-y: auto; }
        .episode-buttons { margin-left: 11px; margin-bottom: 25px; max-height: 118px; overflow-y: auto; }
        .server-btn, .season-btn, .episode-btn { background-color: var(--selector-bg); color: var(--selector-text); border: none; cursor: pointer; transition: all 0.3s ease; }
        .server-btn { border-radius: 12px; padding: 4px 6px; font-size: 0.75rem; }
        .season-btn { border-radius: 5px; width: 76.5px; height: 30px; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; }
        .episode-btn { border-radius: 6px; width: 35px; height: 35px; font-size: 1rem; display: flex; align-items: center; justify-content: center; }
        .server-btn:hover, .season-btn:hover, .episode-btn:hover, .server-btn.active, .season-btn.active, .episode-btn.active { background-color: var(--selector-active); color: #000; }

        .media-details { background: rgba(0, 0, 0, 0.9); padding: 20px; color: var(--text-color); display: none; width: 100%; overflow: hidden; }
        .media-details.active { display: block; }
        .media-details-container { display: flex; flex-wrap: wrap; align-items: flex-start; max-width: 1200px; margin: 0 auto; }
        .media-details-poster { flex: 0 0 150px; max-width: 150px; margin-right: 20px; }
        .media-details-poster img { width: 100%; height: auto; border-radius: 8px; display: block; }
        .media-details-content { flex: 1; min-width: 0; }
        .media-details .title { font-size: 1.5rem; margin-bottom: 5px; word-wrap: break-word; }
        .media-details .year-genre { font-size: 0.9rem; color: #aaa; margin-bottom: 10px; word-wrap: break-word; }
        .media-details .plot { font-size: 0.9rem; line-height: 1.5; word-wrap: break-word; }

        .recently-watched-section, .media-slider-section { position: relative; max-width: 100%; padding: 0 10px; margin-bottom: 25px; }
        .recently-watched-section { display: none; }
        .recently-watched-section.active { display: block; }
        .slider-title { color: var(--primary-color); font-size: 1.2rem; margin: 0 10px; margin-bottom: 10px; font-weight: 700; font-family: 'Lexend', sans-serif; }
        .poster-slider { display: flex; overflow-x: auto; scroll-behavior: smooth; scroll-snap-type: x mandatory; gap: 10px; margin: 0 10px; padding: 5px 0; scrollbar-width: none; -ms-overflow-style: none; }
        .poster-slider::-webkit-scrollbar { display: none; }
        .poster-item { flex: 0 0 auto; width: 120px; scroll-snap-align: start; border-radius: 6px; overflow: hidden; background: var(--card-bg); position: relative; }
        .poster-img { width: 100%; height: 180px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 1px solid transparent; }
        .delete-badge { position: absolute; top: 5px; right: 5px; background: var(--secondary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; }
        .episode-badge { position: absolute; bottom: 5px; left: 5px; background: var(--primary-color); color: black; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; font-weight: bold; opacity: 0.9; z-index: 10; }

        footer { text-align: center; position: relative; width: 100%; color: #777; font-size: 0.6rem; margin-top: 20px; margin-bottom: 10px; }
        .error-message { text-align: center; padding: 10px; color: #ff5555; }

        @media (max-width: 767px) {
            .media-details-poster { flex: 0 0 120px; max-width: 120px; margin-right: 15px; }
            .media-details .title { font-size: 1.2rem; }
            .media-details .year-genre, .media-details .plot { font-size: 0.85rem; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="video-page" id="videoPage">
        <div class="video-header">
            <i class="fas fa-arrow-left back-arrow" id="videoBackArrow"></i>
            <p class="media-title" id="videoMediaTitle"></p>
        </div>
        <div class="video-wrapper">
            <iframe id="videoFrame" src="" allow="fullscreen" allowfullscreen aria-label="Video Player"></iframe>
        </div>
        <div class="selector-container" id="selectorContainer">
            <div class="server-selector">
                <div class="server-buttons" id="serverGrid"></div>
            </div>
            <div class="season-selector" id="seasonSelector" style="display: none;">
                <div class="selector-title">Select Season</div>
                <div class="season-buttons" id="seasonGrid"></div>
            </div>
            <div class="episode-selector" id="episodeSelector" style="display: none;">
                <div class="selector-title">Select Episode</div>
                <div class="episode-buttons" id="episodeGrid"></div>
            </div>
            <div class="media-details" id="mediaDetails">
                <div class="media-details-container">
                    <div class="media-details-poster">
                        <img src="" alt="Media Poster" id="mediaPoster" loading="lazy">
                    </div>
                    <div class="media-details-content">
                        <h3 id="mediaDetailsTitle" class="title"></h3>
                        <p id="mediaYearGenre" class="year-genre"></p>
                        <p id="mediaPlot" class="plot"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="homepage">
        <div class="header">
            <div class="header-content">
                <i class="fas fa-arrow-left back-arrow" id="backArrow" style="display: none;"></i>
                <p class="media-title" id="mediaTitle" style="display: none;"></p>
                <h1 id="mainTitle">Streamzy</h1>
            </div>
            <i class="fas fa-search search-icon" id="searchIcon" role="button" aria-label="Toggle search"></i>
        </div>

        <div class="search-container" id="searchContainer">
            <input type="text" class="search-box" id="searchBox" placeholder="Search movies or TV shows..." aria-label="Search movies or TV shows" />
            <div class="search-results" id="searchResults"></div>
        </div>

        <div class="preview-section" id="previewSection">
            <div class="preview-overlay"></div>
            <div class="preview-content">
                <h2 class="preview-title" id="previewTitle"></h2>
                <p class="preview-genres" id="previewGenres"></p>
                <div class="preview-buttons">
                    <button class="preview-btn" id="previewPlayBtn"><i class="fa-solid fa-play"></i> Play</button>
                </div>
            </div>
        </div>

        <div class="recently-watched-section" id="recentlyWatchedSection">
            <div class="slider-header">
                <h2 class="slider-title">Recently Watched</h2>
            </div>
            <div class="poster-slider" id="recentlyWatchedSlider"></div>
        </div>

        <div class="media-slider-section">
            <div class="slider-header">
                <h2 class="slider-title">Trending Movies</h2>
            </div>
            <div class="poster-slider" id="moviesSliderContainer"></div>
        </div>

        <div class="media-slider-section">
            <div class="slider-header">
                <h2 class="slider-title">Trending TV Shows</h2>
            </div>
            <div class="poster-slider" id="tvSliderContainer"></div>
        </div>

        <div class="media-slider-section">
            <div class="slider-header">
                <h2 class="slider-title">Trending Anime</h2>
            </div>
            <div class="poster-slider" id="animeSliderContainer"></div>
        </div>

        <div class="media-slider-section">
            <div class="slider-header">
                <h2 class="slider-title">Trending K-Drama</h2>
            </div>
            <div class="poster-slider" id="kdramaSliderContainer"></div>
        </div>

        <footer id="footer">
            Â© 2025 Streamzy. All rights reserved.
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            const $elements = {
                videoPage: $('#videoPage'),
                videoFrame: $('#videoFrame'),
                videoBackArrow: $('#videoBackArrow'),
                videoMediaTitle: $('#videoMediaTitle'),
                selectorContainer: $('#selectorContainer'),
                seasonSelector: $('#seasonSelector'),
                episodeSelector: $('#episodeSelector'),
                seasonGrid: $('#seasonGrid'),
                episodeGrid: $('#episodeGrid'),
                serverGrid: $('#serverGrid'),
                mediaDetails: $('#mediaDetails'),
                mediaPoster: $('#mediaPoster'),
                mediaDetailsTitle: $('#mediaDetailsTitle'),
                mediaYearGenre: $('#mediaYearGenre'),
                mediaPlot: $('#mediaPlot'),
                homepage: $('#homepage'),
                mainTitle: $('#mainTitle'),
                searchIcon: $('#searchIcon'),
                searchContainer: $('#searchContainer'),
                searchBox: $('#searchBox'),
                searchResults: $('#searchResults'),
                backArrow: $('#backArrow'),
                mediaTitle: $('#mediaTitle'),
                previewSection: $('#previewSection'),
                previewTitle: $('#previewTitle'),
                previewGenres: $('#previewGenres'),
                previewPlayBtn: $('#previewPlayBtn'),
                loadingOverlay: $('#loadingOverlay'),
                footer: $('#footer'),
                recentlyWatchedSection: $('#recentlyWatchedSection'),
                recentlyWatchedSlider: $('#recentlyWatchedSlider'),
                sliders: {
                    movies: $('#moviesSliderContainer'),
                    tv: $('#tvSliderContainer'),
                    anime: $('#animeSliderContainer'),
                    kdrama: $('#kdramaSliderContainer')
                }
            };

            const state = {
                currentMedia: { type: 'movie', id: null, season: null, episode: null },
                lastSelected: { season: null, episode: null },
                seasonsData: [],
                episodesData: [],
                trendingMovies: [],
                previewIndex: 0,
                previewInterval: null,
                recentlyWatched: JSON.parse(localStorage.getItem('recentlyWatched')) || []
            };

            const constants = {
                apiKey: 'ea118e768e75a1fe3b53dc99c9e4de09',
                fallbackPoster: 'https://via.placeholder.com/150x225?text=No+Poster',
                serverOptions: [
                    { name: "Server 1", url: "https://vidfast.pro" },
                    { name: "Server 2", url: "https://111movies.com" },
                    { name: "Server 3", url: "https://vidsrc.cc/v2" },
                    { name: "Server 4", url: "https://vidsrc.vip" },
                    { name: "Server 5", url: "https://www.2embed.cc" }
                ]
            };

            function init() {
                console.log('Initializing...');
                setupServerSelector();
                loadRecentlyWatched();
                checkRoute();
                setupSearch();
                setupNavigation();
                setTimeout(() => showTimeoutError(), 15000);
            }

            function checkRoute() {
                const path = window.location.pathname;
                console.log('Path:', path);
                path === '/' || path === '' ? loadHomepage() :
                path.startsWith('/movie/') ? handleMediaClick(path.split('/movie/')[1], 'movie') :
                path.startsWith('/tv/') ? handleMediaClick(path.split('/tv/')[1], 'tv') : loadHomepage();
            }

            async function loadHomepage() {
                console.log('Loading homepage...');
                togglePage('homepage');
                $elements.loadingOverlay.removeClass('hidden');
                try {
                    await Promise.all([
                        fetchTrending('movie', $elements.sliders.movies),
                        fetchTrending('tv', $elements.sliders.tv),
                        fetchTrending('anime', $elements.sliders.anime),
                        fetchTrending('kdrama', $elements.sliders.kdrama),
                        loadPreviewMovies()
                    ]);
                    loadRecentlyWatched();
                    $elements.loadingOverlay.addClass('hidden');
                    startPreviewSlideshow();
                } catch (error) {
                    console.error('Homepage error:', error);
                    showError('Failed to load content');
                }
            }

            function setupServerSelector() {
                $elements.serverGrid.empty();
                constants.serverOptions.forEach((server, i) => {
                    const $btn = $(`<button class="server-btn${i === 0 ? ' active' : ''}">${server.name}</button>`)
                        .data('url', server.url)
                        .on('click', () => switchServer(server.url));
                    $elements.serverGrid.append($btn);
                });
            }

            function switchServer(url) {
                $('.server-btn').removeClass('active');
                $(`.server-btn[data-url="${url}"]`).addClass('active');
                embedVideo();
            }

            function getCurrentServer() {
                return $('.server-btn.active').data('url') || constants.serverOptions[0].url;
            }

            function navigateToMedia(tmdbId, type, title, poster, year, season, episode) {
                const path = `${window.location.origin}/${type}/${tmdbId}`;
                window.history.pushState({ tmdbId, type }, '', path);
                handleMediaClick(tmdbId, type, title, poster, year, season, episode);
                if (type === 'movie' || (type === 'tv' && season && episode)) {
                    addToRecentlyWatched(tmdbId, type, title, poster, year, season, episode);
                }
                $elements.searchContainer.removeClass('active');
                $elements.searchBox.val('');
                $elements.searchResults.empty();
                $elements.previewSection.hide();
                stopPreviewSlideshow();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function addToRecentlyWatched(tmdbId, type, title, poster, year, season, episode) {
                if (type === 'tv' && (!season || !episode)) return;
                const uniqueKey = type === 'tv' ? `${tmdbId}-${season}-${episode}` : tmdbId;
                const existingIndex = state.recentlyWatched.findIndex(item => item.id === tmdbId && item.type === type);
                const newItem = {
                    id: tmdbId, uniqueKey, type, title,
                    poster: poster || constants.fallbackPoster,
                    year, season: type === 'tv' ? season : null,
                    episode: type === 'tv' ? episode : null,
                    timestamp: Date.now()
                };
                if (existingIndex !== -1) state.recentlyWatched.splice(existingIndex, 1);
                state.recentlyWatched.unshift(newItem);
                state.recentlyWatched = state.recentlyWatched.slice(0, 10);
                localStorage.setItem('recentlyWatched', JSON.stringify(state.recentlyWatched));
                loadRecentlyWatched();
            }

            function removeFromRecentlyWatched(uniqueKey) {
                state.recentlyWatched = state.recentlyWatched.filter(item => item.uniqueKey !== uniqueKey);
                localStorage.setItem('recentlyWatched', JSON.stringify(state.recentlyWatched));
                loadRecentlyWatched();
            }

            function loadRecentlyWatched() {
                $elements.recentlyWatchedSlider.empty();
                if (!state.recentlyWatched.length) return $elements.recentlyWatchedSection.removeClass('active').hide();
                state.recentlyWatched.forEach(item => {
                    const $item = $(`
                        <div class="poster-item">
                            <img src="${item.poster}" alt="${item.title}" class="poster-img" loading="lazy" />
                            ${item.type === 'tv' ? `<span class="episode-badge">S${String(item.season).padStart(2, '0')}E${String(item.episode).padStart(2, '0')}</span>` : ''}
                            <span class="delete-badge"><i class="fas fa-trash"></i></span>
                        </div>
                    `);
                    $item.find('.poster-img').on('click', e => {
                        e.stopPropagation();
                        navigateToMedia(item.id, item.type, item.title, item.poster, item.year, item.season, item.episode);
                    });
                    $item.find('.delete-badge').on('click', e => {
                        e.stopPropagation();
                        removeFromRecentlyWatched(item.uniqueKey);
                    });
                    $elements.recentlyWatchedSlider.append($item);
                });
                $elements.recentlyWatchedSection.addClass('active').show();
            }

            function togglePage(page) {
                const isHomepage = page === 'homepage';
                $elements.homepage.toggle(isHomepage);
                $elements.videoPage.toggle(!isHomepage).removeClass('active');
                $elements.mainTitle.toggle(isHomepage);
                $elements.searchIcon.toggle(isHomepage);
                $elements.backArrow.toggle(!isHomepage).hide();
                $elements.mediaTitle.toggle(!isHomepage).hide();
                $elements.videoBackArrow.toggle(!isHomepage);
                $elements.videoMediaTitle.toggle(!isHomepage);
                $elements.previewSection.toggle(isHomepage);
                $elements.footer.toggle(isHomepage);
                $elements.selectorContainer.toggle(!isHomepage).removeClass('active');
                $elements.seasonSelector.hide();
                $elements.episodeSelector.hide();
            }

            async function handleMediaClick(mediaId, type, title, poster, year, season, episode) {
                console.log('Media click:', mediaId, type, season, episode);
                Object.assign(state.currentMedia, { id: mediaId, type, season, episode });
                $elements.videoFrame.attr('src', '');
                togglePage('video');
                $elements.videoPage.addClass('active');
                $elements.videoMediaTitle.text(title && year ? `${title}\n(${year.split('-')[0]})` : 'Loading...');
                $elements.loadingOverlay.removeClass('hidden');
                try {
                    if (type === 'movie') {
                        embedVideo();
                        await fetchMediaDetails(mediaId, 'movie');
                    } else {
                        await fetchSeasons(mediaId);
                        await fetchMediaDetails(mediaId, 'tv');
                        if (season && episode) {
                            embedVideo();
                            $(`.season-btn[data-value="${season}"]`).addClass('active');
                            await fetchEpisodes(mediaId, season);
                            $(`.episode-btn[data-value="${episode}"]`).addClass('active');
                        }
                        if (title && poster && year) $elements.videoPage.data({ title, poster, year });
                    }
                    $elements.selectorContainer.addClass('active').show();
                    $elements.seasonSelector.toggle(type === 'tv');
                    $elements.episodeSelector.toggle(type === 'tv');
                    $elements.mediaDetails.addClass('active').show();
                    $elements.loadingOverlay.addClass('hidden');
                } catch (error) {
                    console.error('Media error:', error);
                    $elements.videoMediaTitle.text('Error Loading Media');
                    showError('Failed to load media');
                }
                $('body').css('overflow-y', 'auto');
            }

            function setupNavigation() {
                $elements.videoBackArrow.on('click', () => navigateToHomepage());
                $elements.backArrow.on('click', () => window.history.back());
                window.onpopstate = () => checkRoute();
            }

            function navigateToHomepage() {
                window.history.pushState({}, '', '/');
                $elements.videoFrame.attr('src', '');
                togglePage('homepage');
                loadHomepage();
            }

            async function fetchTrending(category, $slider) {
                const urls = {
                    movie: `https://api.themoviedb.org/3/trending/movie/week?api_key=${constants.apiKey}`,
                    tv: `https://api.themoviedb.org/3/trending/tv/week?api_key=${constants.apiKey}`,
                    anime: `https://api.themoviedb.org/3/discover/tv?api_key=${constants.apiKey}&with_genres=16&sort_by=popularity.desc&with_original_language=ja&vote_average.gte=8&vote_count.gte=1000&first_air_date.gte=1990-01-01`,
                    kdrama: `https://api.themoviedb.org/3/discover/tv?api_key=${constants.apiKey}&with_original_language=ko&sort_by=popularity.desc&sort_by=first_air_date.desc&vote_average.gte=7&vote_count.gte=100&first_air_date.gte=2020-01-01`
                };
                let content = [], page = 1, maxPages = category === 'movie' || category === 'tv' ? 2 : 1;
                try {
                    while (content.length < 20 && page <= maxPages) {
                        const res = await fetch(`${urls[category]}&page=${page++}`);
                        if (!res.ok) break;
                        const data = await res.json();
                        let valid = data.results.filter(item => item.id && (item.title || item.name) && item.poster_path);
                        if (category === 'tv') valid = valid.filter(item => !item.genre_ids.includes(16) && item.original_language !== 'ja' && item.original_language !== 'ko');
                        content = content.concat(valid);
                    }
                    content = content.slice(0, 20);
                    if (!content.length) throw new Error('No content');
                    $slider.empty().append(content.map(item => createPoster(item, category === 'movie' ? 'movie' : 'tv')));
                } catch (error) {
                    console.error(`Fetch ${category} error:`, error);
                    $slider.html('<div class="error-message">Failed to load content</div>');
                }
            }

            function createPoster(item, type) {
                const imageUrl = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : constants.fallbackPoster;
                const $poster = $(`<div class="poster-item"><img src="${imageUrl}" alt="${item.title || item.name}" class="poster-img" loading="lazy" /></div>`);
                $poster.on('click', () => navigateToMedia(item.id, type, item.title || item.name, imageUrl, item.release_date || item.first_air_date));
                return $poster;
            }

            async function fetchMediaDetails(mediaId, type) {
                const url = `https://api.themoviedb.org/3/${type}/${mediaId}?api_key=${constants.apiKey}`;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Fetch failed');
                    const data = await res.json();
                    const poster = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : constants.fallbackPoster;
                    const title = data.title || data.name || 'Unknown Title';
                    const year = (data.release_date || data.first_air_date || '').split('-')[0];
                    const genres = data.genres?.length ? data.genres.map(g => g.name).join(', ') : 'N/A';
                    const plot = data.overview || 'No plot summary available.';
                    $elements.mediaPoster.attr('src', poster);
                    $elements.mediaDetailsTitle.text(title);
                    $elements.mediaYearGenre.text(`${year} | ${genres}`);
                    $elements.mediaPlot.text(plot);
                    $elements.videoMediaTitle.text(`${title}\n(${year})`);
                } catch (error) {
                    console.error('Details error:', error);
                    throw error;
                }
            }

            function embedVideo() {
                const { id, type, season, episode } = state.currentMedia;
                const server = getCurrentServer();
                let url;
                if (type === 'movie') {
                    url = server === 'https://vidfast.pro' ? `${server}/movie/${id}` :
                          server === 'https://www.2embed.cc' ? `${server}/embed/${id}` :
                          server === 'https://vidsrc.cc/v2' ? `${server}/embed/movie/${id}` :
                          server === 'https://111movies.com' ? `${server}/movie/${id}` : `${server}/embed/${type}/${id}`;
                    const { title, year } = $elements.videoPage.data();
                    if (title && year) $elements.videoMediaTitle.text(`${title}\n(${year.split('-')[0]})`);
                } else if (type === 'tv' && season && episode) {
                    url = server === 'https://www.2embed.cc' ? `${server}/embedtv/${id}&s=${season}&e=${episode}` :
                          server === 'https://vidsrc.cc/v2' ? `${server}/embed/tv/${id}/${season}/${episode}` :
                          server === 'https://vidfast.pro' ? `${server}/tv/${id}/${season}/${episode}` :
                          server === 'https://111movies.com' ? `${server}/tv/${id}/${season}/${episode}` : `${server}/embed/${type}/${id}/${season}/${episode}`;
                } else return $elements.videoFrame.attr('src', '');
                $elements.videoFrame.attr('src', url);
                $elements.videoPage.addClass('active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            async function fetchSeasons(mediaId) {
                const url = `https://api.themoviedb.org/3/tv/${mediaId}?api_key=${constants.apiKey}`;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Fetch failed');
                    const data = await res.json();
                    state.seasonsData = data.seasons.filter(s => s.season_number > 0);
                    $elements.videoPage.data({
                        title: data.name || '',
                        poster: data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : constants.fallbackPoster,
                        year: data.first_air_date || ''
                    });
                    $elements.videoMediaTitle.text(`${data.name}\n(${data.first_air_date?.split('-')[0] || ''})`);
                    $elements.seasonGrid.empty().append(state.seasonsData.map(s => {
                        const $btn = $(`<button class="season-btn" data-value="${s.season_number}">Season ${s.season_number}</button>`)
                            .on('click', () => {
                                $('.season-btn').removeClass('active');
                                $btn.addClass('active');
                                state.currentMedia.season = s.season_number;
                                fetchEpisodes(mediaId, s.season_number);
                            });
                        return $btn;
                    }));
                    const season = state.currentMedia.season || 1;
                    const $seasonBtn = $(`.season-btn[data-value="${season}"]`);
                    if ($seasonBtn.length) $seasonBtn.addClass('active').click();
                    else if (state.seasonsData.length) $(`.season-btn[data-value="${state.seasonsData[0].season_number}"]`).addClass('active').click();
                } catch (error) {
                    console.error('Seasons error:', error);
                    $elements.seasonGrid.empty();
                    throw error;
                }
            }

            async function fetchEpisodes(mediaId, season) {
                const url = `https://api.themoviedb.org/3/tv/${mediaId}/season/${season}?api_key=${constants.apiKey}`;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Fetch failed');
                    const data = await res.json();
                    state.episodesData = data.episodes;
                    $elements.episodeGrid.empty().append(state.episodesData.map(e => {
                        const $btn = $(`<button class="episode-btn" data-value="${e.episode_number}" title="${e.name || `Episode ${e.episode_number}`}">${e.episode_number}</button>`)
                            .on('click', () => {
                                $('.episode-btn').removeClass('active');
                                $btn.addClass('active');
                                state.currentMedia.season = season;
                                state.currentMedia.episode = e.episode_number;
                                state.lastSelected = { season, episode: e.episode_number };
                                embedVideo();
                                addToRecentlyWatched(mediaId, 'tv', $elements.videoPage.data('title'), $elements.videoPage.data('poster'), $elements.videoPage.data('year'), season, e.episode_number);
                            });
                        if (season === state.currentMedia.season && e.episode_number === state.currentMedia.episode) $btn.addClass('active').click();
                        return $btn;
                    }));
                } catch (error) {
                    console.error('Episodes error:', error);
                    $elements.episodeGrid.empty();
                    throw error;
                }
            }

            async function loadPreviewMovies() {
                const url = `https://api.themoviedb.org/3/trending/movie/week?api_key=${constants.apiKey}`;
                let movies = [], page = 1;
                try {
                    while (movies.length < 10 && page <= 5) {
                        const res = await fetch(`${url}&page=${page++}`);
                        if (!res.ok) break;
                        const data = await res.json();
                        movies = movies.concat(data.results.filter(m => m.id && m.title && m.backdrop_path && m.poster_path && m.original_language === 'en'));
                    }
                    movies = movies.slice(0, 10);
                    if (!movies.length) throw new Error('No movies');
                    state.trendingMovies = await Promise.all(movies.map(async m => ({
                        ...m,
                        logo_path: await fetchMovieLogo(m.id) || m.poster_path,
                        genres: await fetchMovieGenres(m.id) || 'Unknown'
                    })));
                    $elements.previewSection.prepend(state.trendingMovies.map((m, i) => 
                        `<img class="preview-background${i === 0 ? ' active' : ''}" src="https://image.tmdb.org/t/p/w1280${m.backdrop_path}" alt="${m.title}" data-id="${m.id}" data-title="${m.title}" data-poster="https://image.tmdb.org/t/p/w500${m.poster_path}" data-year="${m.release_date}" loading="${i === 0 ? 'eager' : 'lazy'}">`
                    ));
                    updatePreview(0);
                    setupPreviewTouch();
                } catch (error) {
                    console.error('Preview error:', error);
                    $elements.previewSection.html('<div class="error-message">Failed to load trending movies</div>');
                }
            }

            async function fetchMovieLogo(movieId) {
                try {
                    const res = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/images?api_key=${constants.apiKey}&include_image_language=en,null`);
                    if (!res.ok) return null;
                    const data = await res.json();
                    const logo = (data.logos || []).find(l => l.file_path && l.iso_639_1 === 'en') || data.logos[0];
                    return logo ? `https://image.tmdb.org/t/p/w500${logo.file_path}` : null;
                } catch (error) {
                    console.error('Logo error:', error);
                    return null;
                }
            }

            async function fetchMovieGenres(movieId) {
                try {
                    const res = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${constants.apiKey}`);
                    if (!res.ok) return 'Unknown';
                    const data = await res.json();
                    return data.genres?.length ? data.genres.map(g => g.name).join(', ') : 'Unknown';
                } catch (error) {
                    console.error('Genres error:', error);
                    return 'Unknown';
                }
            }

            function updatePreview(index) {
                $('.preview-background').removeClass('active').eq(index).addClass('active');
                const movie = state.trendingMovies[index];
                $elements.previewTitle.html(`<img src="${movie.logo_path || `https://image.tmdb.org/t/p/w500${movie.poster_path}`}" alt="${movie.title}">`);
                $elements.previewGenres.text(movie.genres);
                $elements.previewPlayBtn.off('click').on('click', e => {
                    e.preventDefault();
                    navigateToMedia(movie.id, 'movie', movie.title, `https://image.tmdb.org/t/p/w500${movie.poster_path}`, movie.release_date);
                });
                [1, 2].forEach(i => new Image().src = `https://image.tmdb.org/t/p/w1280${state.trendingMovies[(index + i) % state.trendingMovies.length].backdrop_path}`);
            }

            function startPreviewSlideshow() {
                if (state.previewInterval) return;
                state.previewInterval = setInterval(() => updatePreview(state.previewIndex = (state.previewIndex + 1) % state.trendingMovies.length), 6000);
            }

            function stopPreviewSlideshow() {
                clearInterval(state.previewInterval);
                state.previewInterval = null;
            }

            function setupPreviewTouch() {
                let startX = 0, endX = 0;
                $elements.previewSection.on({
                    touchstart: e => !$(e.target).closest('.preview-btn').length && (startX = e.originalEvent.touches[0].clientX),
                    touchmove: e => !$(e.target).closest('.preview-btn').length && (endX = e.originalEvent.touches[0].clientX),
                    touchend: e => {
                        if (!$(e.target).closest('.preview-btn').length && startX && Math.abs(startX - endX) > 30) {
                            stopPreviewSlideshow();
                            state.previewIndex = startX > endX ? (state.previewIndex + 1) % state.trendingMovies.length : (state.previewIndex - 1 + state.trendingMovies.length) % state.trendingMovies.length;
                            updatePreview(state.previewIndex);
                            startPreviewSlideshow();
                        }
                        startX = endX = 0;
                    }
                });
            }

            function setupSearch() {
                $elements.searchIcon.on('click keypress', e => {
                    if (e.type === 'click' || e.key === 'Enter' || e.key === ' ') {
                        $elements.searchContainer.toggleClass('active');
                        $elements.searchContainer.hasClass('active') ? $elements.searchBox.focus() : $elements.searchResults.empty() && $elements.searchBox.val('');
                    }
                });
                $elements.searchBox.on('input', debounce(async () => {
                    const query = $elements.searchBox.val().trim();
                    if (query.length < 2) return $elements.searchResults.empty();
                    $elements.searchResults.html('<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
                    try {
                        const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${constants.apiKey}&query=${encodeURIComponent(query)}&page=1`);
                        if (!res.ok) throw new Error('Search failed');
                        const data = await res.json();
                        const results = data.results.filter(item => (item.media_type === 'movie' || item.media_type === 'tv') && item.id && (item.title || item.name) && item.poster_path).slice(0, 10);
                        $elements.searchResults.empty().append(results.map(item => {
                            const title = item.title || item.name;
                            const year = (item.release_date || item.first_air_date || '').split('-')[0];
                            const poster = item.poster_path ? `https://image.tmdb.org/t/p/w92${item.poster_path}` : constants.fallbackPoster;
                            const $item = $(`
                                <div class="search-result-item">
                                    <img src="${poster}" alt="${title}" class="search-result-poster" loading="lazy" />
                                    <div class="search-result-info">
                                        <div class="search-result-title">${title}</div>
                                        <div class="search-result-year">${year || 'N/A'}</div>
                                    </div>
                                </div>
                            `);
                            $item.on('click', () => navigateToMedia(item.id, item.media_type, title, poster.replace('w92', 'w500'), item.release_date || item.first_air_date));
                            return $item;
                        }));
                    } catch (error) {
                        console.error('Search error:', error);
                        $elements.searchResults.empty();
                    }
                }, 300));
            }

            function debounce(func, wait) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            }

            function showError(message) {
                $elements.loadingOverlay.html(`<div class="error-message">${message}<button class="retry-button" onclick="location.reload()">Retry</button></div>`);
            }

            function showTimeoutError() {
                if (!$elements.loadingOverlay.hasClass('hidden')) showError('Loading took too long. Please try again.');
            }

            init();
        });
    </script>
</body>
</html>
